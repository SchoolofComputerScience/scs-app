<template>
  <section class="page">
    <spinner class="spinner" v-if="!loaded" key="spinner"></spinner>
    <div class="member-view" v-if="loaded">
      <transition name="fade" mode="out-in" appear>
        <div>

          <section class="top-header">
            <div class="image" v-if="member.image_url" :style="{ 'background-image': 'url(' + member.image_url + ')' }">
            </div>
            <div>
              <h1 class="full_name">{{member.full_name}}</h1>
              <p class="full_title">{{member.scs_relationship_desc}}</p>
              <p v-if="member.homepage_url" class="homepage"><a :href="member.homepage_url">{{member.homepage_url}}</a></p>
            </div>
          </section>

          <section v-if="position.primary_position" v-for="position in member.positions" class="main-positions">
            <p><router-link :to="'/departments/' + position.department">{{position.department_name}}</router-link></p>
            <p class="job" v-if="position.title">{{position.title | tlc}}</p>
          </section>

          <section v-if="member.positions.length > 0" class="sub-positions">
            <div v-for="position in member.positions" v-if="!position.primary_position">
              <p><router-link :to="'/departments/' + position.department">{{position.department_name}}</router-link></p>
              <p v-if="position.title" class="job">{{position.title | tlc}}</p>
            </div>
          </section>

          <section v-if="member.biography || member.biography != null" class="biography">
            <p class="title">Biography</p>
            <div id="info" v-html="member.biography"></div>
            <button @click="readMore()">Read More</button>
          </section>

          <section class="directory-information">
            <div v-if="!member.phone_full.includes('null') || !member.phone_full">
              <p class="title">phone</p>
              <p><a :to="'tel:' + member.phone_full_call" class="phone">{{member.phone_full}}</a></p>
            </div>
            <div v-if="member.email">
              <p class="title">email</p>
              <p><a :to="'mailto:' + member.email">{{member.email}}</a></p>
            </div>
            <div v-if="member.positions[0].building">
              <p class="title">building</p>
              <p>{{ member.positions[0].building | buildingTranslate }}</a></p>
            </div>
            <div v-if="member.positions[0].room">
              <p class="title">room</p>
              <p>{{member.positions[0].room}}</a></p>
            </div>
          </section>

          <section v-if="member.courses.length > 0" class="courses">
            <p class="title">{{semesterCode | seasonTranslate}} Courses</p>
            <p v-for="course in member.courses">
              <router-link :to="'/courses/course/' + course.courseCode">{{course.longTitle}} | <span>{{course.courseNumber}}</span></router-link>
            </p>
          </section>

          <section v-if="member.research_areas" class="research">
            <p class="title">Research Areas</p>
            <p><span v-for="areas in member.research_areas">{{ areas }}<em>|</em></span></p>
          </section>

          <section v-if="news" class="news">
            <p class="title">news articles</p>
            <div class="card-holder">
              <NewsItem v-for="list in member.news" :key="list.uid" :data="list"></NewsItem>
            </div>
          </section>

          <section v-if="events" class="events">
            <p class="title">events</p>
            <p v-for="event in member.events">
              <router-link :to="'/events/' + event.uid">{{event.title}} | <span>{{event.date | moment("dddd, MMMM Do YYYY")}}</span></router-link>
            </p>
          </section>

          <section v-if="gp" class="publications">
            <p class="title">Cited Publications <span class="amount">(Amount: {{member.gsProfile[0].gs_citation_count}})</span>
            </p>
            <div class="list" v-for="pub in member.gsProfile[0].pub_year_agg">
              <h4>{{pub._id}}</h4>
              <div v-for="art in member.gsPublication">
                <div v-if="art.pub_year == pub._id">
                  <p><router-link :to="'/publication/' + art._id">{{art.title}}</router-link></p>
                </div>
              </div>
            </div>
          </section>

        </div>
      </transition>
    </div>
  </section>
</template>

<script>
import Spinner from '../components/Spinner.vue'
import NewsItem from '../components/NewsItem.vue'

function fetchMember(store) {
  store.dispatch('GET_SEMESTER_CODE');
  return store.dispatch('FETCH_MEMBER', store.state.route.params.name)
}

export default {
  name: 'member-view',

  preFetch: fetchMember,

  components: {
    Spinner,
    NewsItem
  },

  data () {
    return {
      biographyHeight: 0
    }
  },

  computed: {
    loaded() {
      return this.$store.state.member.info[this.$route.params.name] ? true : false
    },
    member(){
      return this.$store.state.member.info[this.$route.params.name]
    },
    gs(){
      return this.$store.state.member.info[this.$route.params.name].gsProfile.length
    },
    gp(){
      return this.$store.state.member.info[this.$route.params.name].gsPublication.length
    },
    news(){
      return this.$store.state.member.info[this.$route.params.name].news.length
    },
    events(){
      return this.$store.state.member.info[this.$route.params.name].events.length
    },
    semesterCode(){
      return this.$store.state.semesterCode.code;
    }
  },

  beforeMount () {
    fetchMember(this.$store)
  },

  ready() {
    console.log("swag")
    this.biographyHeight = this.$el.offsetHeight;
  },

  methods: {
    readMore () {
      let info = document.querySelector('#info')
      if(!info.style.height.includes(info.scrollHeight))
        info.style.height = info.scrollHeight + 'px'
      else
        info.style.height = '120px'
    }
  }
}
</script>

<style lang="stylus">
.biography{
  font-size: .95em;
  padding: 1.6em 0;
  #info{
    overflow-y: hidden;
    transition: .3s height;
  }
  p {
    padding-top: 1em;
    &:first-child{
      padding-top: 0;
    }
  }
  ul{
    display: none;
  }
}
</style>

<style lang="stylus" scoped>
.member-view{
  font-size: 1.05em;
}

.title{
  text-transform: uppercase;
  font-size: .8em;
  padding-bottom: .5em;
  margin-bottom: .5em;
  border-bottom: 1px solid #ccc;
}

.card-holder {
  font-size: .9em;
  display: flex;
  flex-wrap: row;
  flex-flow: wrap;
  width: 100%;
  position: relative;
  display: -webkit-flex;
  display: flex;
  -webkit-flex-wrap: wrap;
  flex-wrap: wrap;
  -webkit-flex-direction: row;
  flex-direction: row;
  > div{
    padding: 0;
    padding-top 1em;
    &:nth-child(1){
      padding-right: 1em;
    }
    &:nth-child(2){
      padding-left: 1em;
    }
  }
  p {
    font-size: .8em;
    em {
      color: #C41230;
    }
  }
}

.events, .research, .courses, .news{
  padding: 1.6em 0;
  p{
    line-height: 1.8em;
  }
  span{
    font-size: .8em;
    font-weight: 900;
  }
}

.research{
  #info{
    transition:height 0.3s ease-out;
  }
  p:nth-child(2) > span > em{
    color: #ccc;
    padding: 0 .8em;
  }
  p:nth-child(2) > span:last-child{
    em{
      display: none;
    }
  }
}

.publications{
  padding-top: 1.6em;
  .title{
    margin-bottom: 2.1em;
  }
  .list{
    border-left: 1px solid #ccc;
    margin-left: 3.2em;
    padding-left: 1em;
    position: relative;
    margin-bottom: 1.6em;
    > h4{
      position: absolute;
      left: -3.2em;
      top: .2em;
    }
  }
  .amount{
    font-size: .8em;
    font-style: italic;
    margin-bottom: 2rem;
    text-transform: uppercase;
  }
  a{
    font-size: .8em;
    margin-top: 2em;
  }
}

.top-header{
  display: flex;
  border-bottom: 1px solid #ccc;
  font-size: 1.4em;
  padding-bottom: 2em;
  padding-top: 2em;
  .homepage{
    font-size: .8em;
    padding-top: 1em;
  }
  .full_title{
    padding-top: .6em;
  }
  div{
    display: inline-block
    &:nth-child(2){
      display: flex;
      flex-direction: column;
      justify-content: center;
    }
  }
  .image{
    width: 8em;
    height: 8em;
    margin-right: 1em;
    background-size: cover;
    border: 1px solid #ccc;
    border-radius: 8em;
    border: .2em solid white;
    background-size: cover;
    box-shadow: 0 1px 3px rgba(0, 0, 0, 0.25);
  }
}

.sub-positions{
  font-size: .85em;
  div{
    display: inline-block;
    margin-right: 2em;
    padding: 1em 0;
    border-top: 1px solid #ccc;

    &:not(:last-child){
      padding-right: 1em;
      margin-right: 1em;
    }
    p{
      padding: 0;
      padding-bottom: .5em;
      text-transform: capitalize;
      &:nth-child(2){
        padding-bottom: 0;
      }
    }
  }
}

.main-positions{
  font-size: 1.1em;
  padding-top: 1.2em;
  padding-bottom: 1.6em;
  p{
    padding: 0;
    padding-top: .95em;
    padding-bottom: .5em;
    padding-left: 1em;
    border-left: 6px solid #C41230;
    text-transform: capitalize;
    &:nth-child(2){
      padding-top: 0;
    }
  }
  div{
    display: inline-block;
    margin-right: 2em;
    padding: 1em 0;
    border-top: 1px solid #ccc;

    &:not(:last-child){
      padding-right: 1em;
      margin-right: 1em;
    }
    p{
      padding: 0;
      padding-bottom: .5em;
      text-transform: capitalize;
      &:nth-child(2){
        padding-bottom: 0;
      }
    }
  }
}

.directory-information{
  padding: 1.6em 0;
  display: flex;
  flex-wrap: wrap;
  > div{
    margin-right: 3.5rem;
  }
  .title{
    text-transform: uppercase;
    font-size: .8em;
    padding-bottom: .5em;
    margin-bottom: .5em;
    border-bottom: 1px solid #ccc;
  }
}
</style>
